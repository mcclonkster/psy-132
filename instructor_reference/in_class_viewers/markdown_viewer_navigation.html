<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nord Studio - Accessible Markdown</title>
    
    <!-- 1. External dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.284.0"
        }
    }
    </script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #2e3440; }
        #root { width: 100vw; height: 100vh; }
        
        /* Custom Scrollbar for Nord Theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #3b4252; }
        ::-webkit-scrollbar-thumb { background: #4c566a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #81a1c1; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="module">
        import React from 'react';
        import ReactDOM from 'react-dom';

        const mjsContent = `
import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  FileText, Eye, Edit3, Download, Copy, Trash2, Moon, Sun,
  Layout, Clock, Code, Type, Maximize2, Minimize2, List, ChevronRight
} from 'lucide-react';

const NORD = {
  polar0: '#2e3440', polar1: '#3b4252', polar2: '#434c5e', polar3: '#4c566a',
  snow0: '#d8dee9', snow1: '#e5e9f0', snow2: '#eceff4',
  frost0: '#8fbcbb', frost1: '#88c0d0', frost2: '#81a1c1', frost3: '#5e81ac',
  aurora0: '#bf616a', aurora1: '#d08770', aurora2: '#ebcb8b', aurora3: '#a3be8c', aurora4: '#b48ead'
};

const App = () => {
  const [markdown, setMarkdown] = useState('');
  const [viewMode, setViewMode] = useState('split'); 
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [isFocusMode, setIsFocusMode] = useState(false);
  const [fontSize, setFontSize] = useState(18);
  const [showSidebar, setShowSidebar] = useState(true);

  useEffect(() => {
    const savedContent = localStorage.getItem('markdown_studio_content');
    setMarkdown(savedContent || DEFAULT_MARKDOWN);

    const loadScript = (src) => new Promise((resolve) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      document.head.appendChild(script);
    });

    Promise.all([
      loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js'),
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js')
    ]).then(() => {
      if (window.marked) {
        const renderer = new window.marked.Renderer();
        
        // Handle new Marked.js API (v7+) where heading is an object
        renderer.heading = (arg1, arg2) => {
          let text, depth;
          if (typeof arg1 === 'object' && arg1 !== null) {
            text = arg1.text;
            depth = arg1.depth;
          } else {
            text = arg1;
            depth = arg2;
          }
          const id = String(text || '').toLowerCase().replace(/[^\\w]+/g, '-');
          return \`<h\${depth || 1} id="\${id}">\${text || ''}</h\${depth || 1}>\`;
        };

        window.marked.setOptions({
          renderer: renderer,
          breaks: true, 
          gfm: true
        });

        // Trigger an update to apply highlighting after hljs is loaded
        setMarkdown(prev => prev + ' ');
        setTimeout(() => setMarkdown(prev => prev.trimEnd()), 50);
      }
    });
  }, []);

  useEffect(() => {
    localStorage.setItem('markdown_studio_content', markdown);
  }, [markdown]);

  const headers = useMemo(() => {
    const lines = markdown.split('\\n');
    const extracted = [];
    const headerRegex = /^(#{1,3})\\s+(.+)$/;

    lines.forEach((line) => {
      const match = line.match(headerRegex);
      if (match) {
        const level = match[1].length;
        const text = match[2];
        const id = text.toLowerCase().replace(/[^\\w]+/g, '-');
        extracted.push({ level, text, id });
      }
    });
    return extracted;
  }, [markdown]);

  const renderedHtml = useMemo(() => {
    if (!window.marked) return '';
    try { 
      let html = window.marked.parse(markdown);
      
      // Post-process highlighting if hljs is available
      if (window.hljs) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        tempDiv.querySelectorAll('pre code').forEach((block) => {
          window.hljs.highlightElement(block);
        });
        return tempDiv.innerHTML;
      }
      return html;
    } 
    catch (e) { 
      console.error("Marked Error:", e);
      return \`<p style="color:red">Error parsing: \${e.message}</p>\`; 
    }
  }, [markdown]);

  const scrollToHeader = (id) => {
    const element = document.getElementById(id);
    if (element) {
      element.scrollIntoView({ behavior: 'smooth' });
    }
  };

  const bgColor = isDarkMode ? NORD.polar0 : NORD.snow2;
  const secondaryBg = isDarkMode ? NORD.polar1 : NORD.snow1;
  const borderColor = isDarkMode ? NORD.polar2 : NORD.snow0;
  const textColor = isDarkMode ? NORD.snow2 : NORD.polar0;
  const mutedText = isDarkMode ? NORD.snow0 : NORD.polar3;

  const isSidebarVisible = viewMode === 'preview' && showSidebar;

  return (
    <div className="flex flex-col h-screen overflow-hidden font-sans transition-colors duration-300"
         style={{ backgroundColor: bgColor, color: textColor }}>
      
      {!isFocusMode && (
        <header className="flex items-center justify-between px-6 py-4 border-b z-10"
                style={{ borderColor: borderColor, backgroundColor: isDarkMode ? NORD.polar0 : '#ffffff' }}>
          <div className="flex items-center gap-3">
            <div className="p-2 rounded-lg shadow-lg" style={{ backgroundColor: NORD.frost3 }}>
              <FileText size={22} className="text-white" />
            </div>
            <div className="hidden sm:block">
              <h1 className="text-lg font-bold leading-none">Nord Studio</h1>
              <p className="text-[10px] uppercase tracking-widest mt-1 font-semibold" style={{ color: NORD.frost2 }}>Markdown Editor</p>
            </div>
          </div>

          <nav className="flex items-center gap-3 sm:gap-6">
            <div className="hidden md:flex items-center gap-3 px-3 py-1.5 rounded-lg border" style={{ backgroundColor: secondaryBg, borderColor: borderColor }}>
              <Type size={14} style={{ color: mutedText }} />
              <input type="range" min="14" max="32" value={fontSize} 
                     onChange={(e) => setFontSize(parseInt(e.target.value))}
                     className="w-20 h-1.5 cursor-pointer accent-nord-frost" />
            </div>

            <div className="flex items-center p-1 rounded-lg border shadow-sm" style={{ backgroundColor: secondaryBg, borderColor: borderColor }}>
              {[
                { id: 'edit', icon: <Edit3 size={18} />, label: 'Edit' }, 
                { id: 'split', icon: <Layout size={18} />, label: 'Split' }, 
                { id: 'preview', icon: <Eye size={18} />, label: 'View' }
              ].map(mode => (
                <button key={mode.id} onClick={() => setViewMode(mode.id)} className="p-2 rounded-md transition-all flex items-center gap-2"
                        title={mode.label}
                        style={{ 
                          backgroundColor: viewMode === mode.id ? (isDarkMode ? NORD.polar3 : '#fff') : 'transparent', 
                          color: viewMode === mode.id ? NORD.frost2 : mutedText,
                          boxShadow: viewMode === mode.id ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
                        }}>
                  {mode.icon}
                </button>
              ))}
            </div>

            <div className="flex items-center gap-2">
                {viewMode === 'preview' && (
                  <button onClick={() => setShowSidebar(!showSidebar)} 
                          className="p-2 rounded-lg border transition-colors"
                          title="Toggle Navigation"
                          style={{ borderColor: borderColor, backgroundColor: showSidebar ? secondaryBg : 'transparent' }}>
                    <List size={20} style={{ color: showSidebar ? NORD.frost2 : mutedText }} />
                  </button>
                )}
                
                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 hover:bg-black/5 rounded-full" style={{ color: mutedText }}>
                  {isDarkMode ? <Sun size={20} /> : <Moon size={20} />}
                </button>
                <button onClick={() => setIsFocusMode(true)} className="px-4 py-2 rounded-lg font-bold text-white bg-slate-800 hover:bg-slate-700 transition-colors flex items-center gap-2 text-sm shadow-md">
                  <Maximize2 size={16} /> Present
                </button>
            </div>
          </nav>
        </header>
      )}

      <main className="flex-1 flex overflow-hidden relative">
        {isSidebarVisible && (
          <aside className="w-64 border-r flex flex-col shrink-0 transition-all duration-300"
                 style={{ borderColor: borderColor, backgroundColor: isDarkMode ? NORD.polar1 : NORD.snow1 }}>
            <div className="p-4 border-b flex items-center gap-2" style={{ borderColor: borderColor }}>
              <List size={14} className="opacity-50" />
              <span className="text-xs font-bold uppercase tracking-wider opacity-60">Navigation</span>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-1">
              {headers.length > 0 ? headers.map((h, i) => (
                <button 
                  key={i} 
                  onClick={() => scrollToHeader(h.id)}
                  className="w-full text-left py-1.5 px-2 rounded hover:bg-black/5 transition-colors flex items-start gap-2 group"
                >
                  <ChevronRight size={14} className="mt-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0" style={{ color: NORD.frost2 }} />
                  <span className={\`truncate \${h.level === 1 ? 'font-bold' : h.level === 2 ? 'pl-2 text-sm' : 'pl-4 text-xs opacity-80'}\`}>
                    {h.text}
                  </span>
                </button>
              )) : (
                <p className="text-xs italic opacity-40 text-center mt-10">No headers found in your markdown.</p>
              )}
            </div>
          </aside>
        )}

        {(viewMode === 'edit' || viewMode === 'split') && (
          <section className={\`flex flex-col h-full border-r \${viewMode === 'edit' ? 'flex-1' : 'w-1/2 md:w-2/5'}\`} style={{ borderColor: borderColor }}>
            <div className="px-4 py-1 text-[10px] font-bold uppercase opacity-40 border-b" style={{ borderColor: borderColor }}>Editor</div>
            <textarea 
                className="flex-1 p-8 resize-none outline-none font-mono leading-relaxed"
                style={{ backgroundColor: isDarkMode ? '#282c34' : '#fff', color: textColor, fontSize: \`\${fontSize - 2}px\` }}
                spellCheck="false"
                value={markdown} 
                onChange={(e) => setMarkdown(e.target.value)} 
            />
          </section>
        )}

        {(viewMode === 'preview' || viewMode === 'split') && (
          <section className="flex-1 overflow-y-auto flex flex-col" 
                   style={{ backgroundColor: isFocusMode ? bgColor : (isDarkMode ? NORD.polar0 : '#fff') }}>
             {!isFocusMode && (
                <div className="px-4 py-1 text-[10px] font-bold uppercase opacity-40 border-b shrink-0" style={{ borderColor: borderColor }}>Preview</div>
             )}
            <article className={\`prose max-w-4xl mx-auto w-full \${isFocusMode ? 'p-12 md:p-32' : 'p-8 md:p-16'}\`} 
                     style={{ fontSize: \`\${fontSize}px\`, color: textColor }}
                     dangerouslySetInnerHTML={{ __html: renderedHtml }} />
          </section>
        )}

        {isFocusMode && (
           <button 
             onClick={() => setIsFocusMode(false)}
             className="fixed top-8 right-8 p-3 rounded-full bg-black/20 hover:bg-black/40 text-white backdrop-blur-md transition-all border border-white/10"
           >
             <Minimize2 size={24} />
           </button>
        )}
      </main>

      <style>{\`
        article h1 { font-size: 2.5em; font-weight: 800; color: \${NORD.frost3}; border-bottom: 2px solid \${isDarkMode ? NORD.polar2 : NORD.snow0}; margin-bottom: 0.8em; padding-bottom: 0.2em; }
        article h2 { font-size: 1.8em; font-weight: 700; color: \${NORD.frost2}; margin-top: 1.5em; margin-bottom: 0.5em; border-bottom: 1px solid \${isDarkMode ? NORD.polar3 : NORD.snow1}; padding-bottom: 0.1em;}
        article h3 { font-size: 1.4em; font-weight: 600; color: \${NORD.frost1}; margin-top: 1.2em; }
        article p { margin-bottom: 1.2em; line-height: 1.7; opacity: 0.9; }
        article blockquote { border-left: 5px solid \${NORD.frost0}; padding-left: 1.5em; font-style: italic; opacity: 0.8; margin: 2em 0; }
        article pre { background: #242933 !important; color: #eceff4; padding: 1.5em; border-radius: 12px; overflow: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); margin: 1.5em 0; }
        article code { color: \${NORD.aurora0}; background: rgba(0,0,0,0.05); padding: 0.2em 0.4em; border-radius: 4px; font-family: 'Fira Code', monospace; font-size: 0.9em; }
        article pre code { color: inherit !important; background: transparent !important; padding: 0 !important; }
        article ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1.2em; }
        article ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1.2em; }
        article li { margin-bottom: 0.4em; }
        article a { color: \${NORD.frost2}; text-decoration: underline; text-underline-offset: 4px; }
        article img { border-radius: 12px; max-width: 100%; height: auto; margin: 2em auto; display: block; }
        html { scroll-behavior: smooth; }
        
        /* Highlight.js Nord styles */
        .hljs-keyword, .hljs-selector-tag { color: #81a1c1; }
        .hljs-string { color: #a3be8c; }
        .hljs-title, .hljs-section { color: #88c0d0; }
        .hljs-variable, .hljs-template-variable { color: #8fbcbb; }
        .hljs-comment { color: #4c566a; }
      \`}</style>
    </div>
  );
};

const DEFAULT_MARKDOWN = \`# Welcome to Nord Studio

This is a premium, AAA-compliant Markdown experience. 

## Key Features
- **Real-time Preview**: See changes as you type.
- **Dynamic Sidebar**: Navigation updates automatically based on your headers.
- **View Mode Navigation**: Sidebar is only active in the full "View" mode.
- **Focus Mode**: Click "Present" for a distraction-free experience.

## Technical Details
This editor uses a robust parser and syntax highlighting.

\\\x60\\\x60\\\x60javascript
function nordTheme() {
  const colors = ["#2e3440", "#5e81ac", "#81a1c1"];
  console.log("Applying Nord styles...");
  return colors;
}
\\\x60\\\x60\\\x60

### Accessibility
We use high-contrast NORD palettes to ensure readability across different light conditions.

> "Simplicity is the ultimate sophistication." 
> â€” Leonardo da Vinci
\`;

export default App;
        `;

        async function mountComponent(sourceCode) {
            try {
                const { code } = Babel.transform(sourceCode, {
                    presets: ['react'],
                    filename: 'virtual-module.js'
                });
                const base64Code = btoa(unescape(encodeURIComponent(code)));
                const dataUri = "data:text/javascript;base64," + base64Code;
                const module = await import(dataUri);
                if (module.default) {
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(React.createElement(module.default));
                }
            } catch (err) {
                console.error(err);
                document.getElementById('root').innerHTML = '<pre style="color:white;padding:20px">' + err.message + '</pre>';
            }
        }

        mountComponent(mjsContent);
    </script>
</body>
</html>